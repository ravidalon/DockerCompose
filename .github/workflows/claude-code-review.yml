name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if workflow file was modified
        id: check-workflow
        run: |
          # Check if this specific workflow file was changed
          WORKFLOW_FILE=".github/workflows/claude-code-review.yml"
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "^${WORKFLOW_FILE}$"; then
            echo "workflow_modified=true" >> $GITHUB_OUTPUT
            echo "⚠️  This PR modifies the Claude Code Review workflow itself"
            echo "Automatically passing to allow workflow modifications"
          else
            echo "workflow_modified=false" >> $GITHUB_OUTPUT
          fi

      - name: Auto-pass for workflow modifications
        if: steps.check-workflow.outputs.workflow_modified == 'true'
        run: |
          echo "✅ Auto-passing: This PR modifies the Claude Code Review workflow"
          echo "Workflow modifications require manual review but won't be blocked by this check"
          exit 0

      - name: Run Claude Code Review
        if: steps.check-workflow.outputs.workflow_modified == 'false'
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            You are conducting a MANDATORY code review that will determine if this PR can be merged.

            **Context:** This is a demo project showcasing Docker Compose microservices with Vue 3 frontend,
            so standards should be appropriate for a demo/educational repository (not production-critical).

            ## Review Process:

            1. Check if this PR has already been reviewed by looking at existing comments using `gh pr view`.

            2. If there are existing Claude Code review comments:
               - Only review the NEW changes since the last review (use `gh pr diff`)
               - Focus on whether previous HIGH PRIORITY feedback was addressed
               - Determine if remaining issues are acceptable for a demo project

            3. If this is the FIRST review:
               - Review the entire pull request comprehensively
               - Categorize issues as: HIGH, MEDIUM, or LOW priority
               - Consider demo project context when prioritizing

            ## Merge Criteria:

            ✅ **PASS (Approve for merge)** if:
            - No HIGH priority issues (security vulnerabilities, critical bugs, data loss risks)
            - Code follows repository conventions (see CLAUDE.md)
            - Changes work as intended for demo purposes
            - Any MEDIUM/LOW issues are acceptable for a demo project

            ❌ **FAIL (Block merge)** if:
            - HIGH priority security issues exist
            - Critical bugs that break core functionality
            - Code quality is severely below standards
            - Previous HIGH priority feedback was not addressed

            ## Your Tasks:

            1. Conduct the code review and post your findings as a comment using `gh pr comment`

            2. At the END of your review comment, add a clear verdict section:

            For PASS:
            ```
            ## ✅ Verdict: APPROVED FOR MERGE

            This PR meets the quality standards for a demo project and has no blocking issues.
            ```

            For FAIL:
            ```
            ## ❌ Verdict: CHANGES REQUIRED

            This PR has blocking issues that must be addressed before merge:
            - [List HIGH priority issues that must be fixed]
            ```

            The workflow will automatically parse your verdict from the comment.

          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Bash(echo:*)"'

      - name: Check Review Result
        if: steps.check-workflow.outputs.workflow_modified == 'false'
        id: check-result
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Fetching latest Claude review comment..."
          COMMENT=$(gh pr view ${{ github.event.pull_request.number }} --json comments --jq -r '[.comments[] | select(.author.login == "claude")] | last | .body')

          if echo "$COMMENT" | grep -iq "Verdict:.*APPROVED FOR MERGE"; then
            echo "✅ Claude Code Review: APPROVED"
            echo "result=PASS" >> $GITHUB_OUTPUT
            exit 0
          elif echo "$COMMENT" | grep -iq "Verdict:.*CHANGES REQUIRED"; then
            echo "❌ Claude Code Review: CHANGES REQUIRED"
            echo "result=FAIL" >> $GITHUB_OUTPUT
            echo "::error::Code review found blocking issues. Please address the feedback and push new commits."
            exit 1
          else
            echo "::error::Could not find valid verdict in Claude's comment"
            echo "::error::Expected either 'Verdict: APPROVED FOR MERGE' or 'Verdict: CHANGES REQUIRED'"
            exit 1
          fi

      - name: Post Status Comment
        if: failure() && steps.check-workflow.outputs.workflow_modified == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ **Claude Code Review Failed**\n\nThis PR has blocking issues that must be addressed before it can be merged. Please review the feedback above and push fixes.'
            })
