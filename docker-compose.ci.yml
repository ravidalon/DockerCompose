# docker-compose.ci.yml
# CI/CD-specific configuration
# Use with: docker compose -f docker-compose.yml -f docker-compose.ci.yml up
#
# CI-specific overrides:
# - No bind mounts (tests built images)
# - Production environment settings
# - No exposed ports (internal networking only)
# - Faster health checks

services:
  echo:
    environment:
      - FLASK_ENV=production

  database:
    environment:
      - FLASK_ENV=production

  fileshare:
    environment:
      - FLASK_ENV=production

  neo4j:
    ports: []  # No external access needed
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 30s

  traefik:
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--log.level=${TRAEFIK_LOG_LEVEL:-INFO}"
      - "--ping=true"

  tests:
    networks:
      - backend_network
      - database_network
    depends_on:
      fileshare:
        condition: service_healthy
      database:
        condition: service_healthy
      neo4j:
        condition: service_healthy
    restart: "no"  # Fail fast in CI
